$(document).ready(function() {
    $('.drag').draggable({
      'appendTo': 'body',
      'helper': 'clone'
    });

    $('#dropzone-rtn').droppable({
      activeClass: 'active',
      hoverClass: 'hover',
      accept: ":not(.ui-sortable-helper)", // Reject clones generated by sortable
      drop: function (e, ui) {
        var new_item = ui.draggable.text()
        var rid = $("#dropzone-rtn").data("rid")
        $.ajax({
            method: "POST",
            contentType: 'application/json;charset=UTF-8',
            url: "/update-sys-tag",
            data: JSON.stringify({
                'item': new_item,
                'rid': rid
            }),
            success: function (res) {
                console.log(res.response)
                location.reload();
            },
            error: function () {
                console.log('Error');
            }
        });
      }
    });

    $('#dropzone-cmd1').droppable({
      activeClass: 'active',
      hoverClass: 'hover',
      accept: ":not(.ui-sortable-helper)", // Reject clones generated by sortable
      drop: function (e, ui) {
        var new_item = ui.draggable.text()
        var rid = $("#dropzone-rtn").data("rid")
        $.ajax({
            method: "POST",
            contentType: 'application/json;charset=UTF-8',
            url: "/update-cmd1-tag",
            data: JSON.stringify({
                'item': new_item,
                'rid': rid
            }),
            success: function (res) {
                console.log(res.response)
                location.reload();
            },
            error: function () {
                console.log('Error');
            }
        });
      }
    });

    $('#dropzone-cmd2').droppable({
      activeClass: 'active',
      hoverClass: 'hover',
      accept: ":not(.ui-sortable-helper)", // Reject clones generated by sortable
      drop: function (e, ui) {
        var new_item = ui.draggable.text()
        var rid = $("#dropzone-rtn").data("rid")
        $.ajax({
            method: "POST",
            contentType: 'application/json;charset=UTF-8',
            url: "/update-cmd2-tag",
            data: JSON.stringify({
                'item': new_item,
                'rid': rid
            }),
            success: function (res) {
                console.log(res.response)
                location.reload();
            },
            error: function () {
                console.log('Error');
            }
        });
      }
    });

    // For customized tags
    $('#task-modal').on('show.bs.modal', function (event) {
      const button = $(event.relatedTarget) // Button that triggered the modal
      const taskID = button.data('source') // Extract info from data-* attributes
      const priority = button.data('priority') // Extract info from data-* attributes

      const modal = $(this)
      if (taskID === 'New Tag') {
          modal.find('.modal-title').text('Add New Tag')
          $('#task-form-display').removeAttr('taskID')
      } else {
          modal.find('.modal-title').text('Edit Task ' + taskID)
          modal.find('.data-tag-name').val(taskID);
          $('#task-form-display').attr('taskID', taskID)
      }

      if (priority) {
          modal.find('.tag-priority').val(priority);
      } else {
          modal.find('.tag-priority').val('');
      }
    });


    $('#submit-task').click(function () {
        const tID = $('#task-form-display').attr('taskID');
        var rid = $("#dropzone-rtn").data("rid")
        $.ajax({
            type: 'POST',
            url: tID ? '/edit-tag' : '/create-tag',
            contentType: 'application/json;charset=UTF-8',
            data: JSON.stringify({
                'tag_name': $('#task-modal').find('.data-tag-name').val(),
                'priority': $('#task-modal').find('.tag-priority').val(),
                'rid': rid
            }),
            success: function (res) {
                console.log(res.response)
                location.reload();
            },
            error: function () {
                console.log('Error');
            }
        });
    });

    $('.cus-tag-remove').click(function () {
        const remove = $(this)
        $.ajax({
            type: 'POST',
            url: '/delete-tag',
            contentType: 'application/json;charset=UTF-8',
            data: JSON.stringify({
                'tag_name': remove.data('source')
            }),
            success: function (res) {
                console.log(res.response)
                location.reload();
            },
            error: function () {
                console.log('Error');
            }
        });
    });
});